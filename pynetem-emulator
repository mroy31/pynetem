#!/usr/bin/python3
# pynetem: network emulator
# Copyright (C) 2015-2017 Mickael Royer <mickael.royer@recherche.enac.fr>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

import sys
import os
import logging
import signal
from optparse import OptionParser
from pynetem.ui.config import NetemConfig
from pynetem.project import NetemProject
from pynetem.console import NetemConsole
from pynetem.daemon.client import NetemDaemonClient
from pynetem import NetemError
from pynetem.utils import get_exc_desc
from pynetem import __version__, NETEM_ID


usage = "usage: %prog [options] <network file>"
parser = OptionParser(usage=usage)
parser.set_defaults(debug=False, conffile=None, version=False, clean=False)
parser.add_option("-c", "--conf-file", type="string", dest="conffile",
                  metavar="FILE", help="Specify a custom conf file")
parser.add_option("-d", "--debug", action="store_true", dest="debug",
                  help="Log more debug informations")
parser.add_option("-v", "--version", action="store_true", dest="version",
                  help="Log more debug informations")
parser.add_option("-l", "--clean", action="store_true", dest="clean",
                  help="Clean the netem env")
(options, args) = parser.parse_args()

if __name__ == "__main__":
    # if asked, show version and quit
    if options.version:
        print(__version__)
        sys.exit()

    if len(args) > 1:
        sys.exit("Too many arguments -> %s" % usage)

    # add custom config parms
    if options.conffile:
        if os.path.isfile(options.conffile):
            NetemConfig.custom_conf = options.conffile
        else:
            sys.exit("The config file does not exist.")

    config = NetemConfig.instance()
    log_format = '%(levelname)s: %(message)s'
    log_level = options.debug and logging.DEBUG or logging.INFO
    logging.basicConfig(format=log_format, level=log_level)

    # test the connection with the daemon and its version
    s_name = config.get("general", "daemon_socket")
    daemon = NetemDaemonClient().instance()
    daemon.set_socket_path(s_name)
    try:
        d_version = daemon.version()
    except NetemError:
        sys.exit("Unable to connect with the daemon, we have to quit")
    if d_version != __version__:
        sys.exit("Version mismatch between the client an the server: "
                 "%s != %s" % (d_version, __version__))

    # if asked clean old project and quit
    if options.clean:
        logging.info("Clean old pynetem project, please wait...")
        daemon.clean(NETEM_ID)
        sys.exit()

    project = None
    if len(args) == 1:
        prj_path = args[0]
        if os.path.isfile(prj_path):
            project = NetemProject.load(daemon, prj_path)
        else:
            logging.info("Create empty project %s" % prj_path)
            project = NetemProject.create(daemon, prj_path)

        # check before load the topology
        try:
            project.topology.check()
        except NetemError as err:
            print(err)
            print("You must edit the topology before loading the project")
        else:
            try:
                project.load_topology()
            except NetemError as err:
                logging.error("An error happened during the loading of "
                              "project %s, close it and exit" % prj_path)
                project.close()
                sys.exit(1)
            except Exception as ex:
                project.close()
                print(get_exc_desc())
                sys.exit("Unhandled excetion during the "
                         "load/create of project")

    console = NetemConsole(daemon, project=project)

    # install signal handlers
    def interrupt(s, f):
        print("\n To quit pynetem, simply enter quit in the console !")

    signal.signal(signal.SIGINT, interrupt)

    # start console
    console.cmdloop()
